<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <title>&lt;HTTL/&gt; by httl</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>&lt;HTTL/&gt;</h1>
        <h2>HTTL是一个适用于HTML输出的开源JAVA模板引擎.</h2>

        <section id="downloads">
          <a href="https://github.com/downloads/httl/httl/httl-1.0.0.jar" class="btn">Download bin.jar</a>
          <a href="https://github.com/downloads/httl/httl/httl-1.0.0-sources.jar" class="btn">Download src.jar</a>
          <a href="https://github.com/httl/httl" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1>1. 概述</h1>

<p>HTTL是一个适用于HTML输出的开源JAVA模板引擎，可替代JSP，指令类似于Velocity。</p>

<h3>快速</h3>

<p>类似于JSP的原理，将模板编译成Java字节码运行，但比JSP的EL更进一步，使用强类型推导，减少运行期反射和转型，更加快速.</p>

<h3>简洁</h3>

<p>保持最简洁指令集，只保留基本的占位/注释/转义，和八个必需的控制指令，其它都降级为表达式方法实现，比如$!{include("a.httl")}。</p>

<h3>直觉</h3>

<p>语法尽可能符合HTML和JAVA开发者的直觉，指令类似于常用Velocity指令，但改进了Velocity中不符合直觉的地方，请参见下面的对比。</p>

<h3>友好</h3>

<p>模板自描述，在模板内声明入参变量类型，并基于入参类型推导模板内所有变量类型，使IDE能方便的实现变量方法补全提示，对开发过程友好。</p>

<h1>2. 对比</h1>

<p>如果你用过Velocity模板，可以查看以下对比，加深了解：</p>

<h2>2.1 语法对比</h2>

<ol>
<li><p>HTTL指令必需加注释外壳，只支持&lt;!--#if(x)--&gt;，不支持#if(x)，确保不干扰HTML本身的有效源码。 </p></li>
<li><p>HTTL指令中的变量不加$符，只支持&lt;!--#foreach(book in books)--&gt;，不支持&lt;!--#foreach($book in $books)--&gt;，因为指令中没有加引号的字符串就是变量，和常规语言的语法一样，加$有点废话。 </p></li>
<li><p>HTTL占位符必需加大括号，只支持${aaa}，不支持$aaa，因为$在JavaScript中也是合法变量名符号，而${}不是，减少混淆，也防止多人开发时，有人加大括号，有人不加，干脆没得选，都加，保持一致。 </p></li>
<li><p>HTTL占位符当变量为null时输出空白串，而不像Velocity那样原样输出指令原文，即${aaa}，等价于Velocity的$!{aaa}，以免开发人员忘写感叹号，泄漏表达式源码，如需原样输出，可使用转义\${aaa}，
在HTTL中，$!{aaa}表示不对内容进行过滤，用于原样输出HTML片段。</p></li>
<li><p>HTTL支持在所有使用变量的地方，进行表达式计算，也就是你不需要像Velocity那样，先#set($j = $i + 1)，再#if($j == $m)，可以直接&lt;!--#if(i + 1 == $m)--&gt;，其它指令也一样。</p></li>
<li><p>HTTL采用扩展Class原生方法的方式，如：${"a".toChar}，而不像Velocity的Tool工具方法那样：$(StringTool.toChar("a"))，这样的调用方式更直观，更符合代码书写习惯。</p></li>
</ol><h2>2.2 指令对比</h2>

<table>
<tr>
<td>HTTL</td>
<td>Velocity</td>
<td>异同</td>
<td>功能</td>
</tr>
<tr>
<td>${xxx.yyy}</td>
<td>$xxx.yyy<br>${xxx.yyy}</td>
<td>相同</td>
<td>输出占位符</td>
</tr>
<tr>
<td>$!{xxx.yyy}</td>
<td>$!xxx.yyy<br>$!{xxx.yyy}</td>
<td>不同</td>
<td>一个是不过滤，一个是不原样输出</td>
</tr>
<tr>
<td>&lt;!--## ... --&gt;</td>
<td>## ...<br>#* ... *#</td>
<td>相似</td>
<td>不显示注释块</td>
</tr>
<tr>
<td>&lt;![CDATA[## ... ]]&gt;</td>
<td>#[[ ... ]]#</td>
<td>相似</td>
<td>不解析文本块</td>
</tr>
<tr>
<td>\# \$ \\</td>
<td>\# \$ \\</td>
<td>相同</td>
<td>特殊符转义</td>
</tr>
<tr>
<td>&lt;!--#var(Xxx xxx)--&gt;</td>
<td>不支持</td>
<td>不同</td>
<td>定义输入参数类型</td>
</tr>
<tr>
<td>&lt;!--#set(xxx = yyy)--&gt;</td>
<td>#set($xxx = $yyy)</td>
<td>相同</td>
<td>给变量赋值</td>
</tr>
<tr>
<td>&lt;!--#if(xxx == yyy)--&gt;</td>
<td>#if($xxx == $yyy)</td>
<td>相同</td>
<td>条件判断</td>
</tr>
<tr>
<td>&lt;!--#elseif(xxx == yyy)--&gt;</td>
<td>#elseif($xxx == $yyy)</td>
<td>相同</td>
<td>否则条件判断</td>
</tr>
<tr>
<td>&lt;!--#else--&gt;</td>
<td>#else</td>
<td>相同</td>
<td>否则判断</td>
</tr>
<tr>
<td>&lt;!--#end--&gt;</td>
<td>#end</td>
<td>相同</td>
<td>结束指令</td>
</tr>
<tr>
<td>&lt;!--#foreach(item in list)--&gt;</td>
<td>#foreach($item in $list)</td>
<td>相同</td>
<td>列表循环</td>
</tr>
<tr>
<td>&lt;!--#breakif(xxx == yyy)--&gt;</td>
<td>#if($xxx == $yyy) #break #end</td>
<td>相似</td>
<td>中断循环</td>
</tr>
<tr>
<td>&lt;!--#macro(xxx)--&gt;</td>
<td>#macro($xxx)</td>
<td>相似</td>
<td>宏替换，模板片断</td>
</tr>
<tr>
<td>&lt;!--#set(xxx=xxxmacro())--&gt;</td>
<td>#define($xxx)</td>
<td>相似</td>
<td>捕获块输出到变量中</td>
</tr>
<tr>
<td>$!{read("xxx.txt")}</td>
<td>#include("xxx.txt")</td>
<td>相似</td>
<td>读取文本文件内容</td>
</tr>
<tr>
<td>$!{include("xxx.httl")}</td>
<td>#parse("xxx.vm")</td>
<td>相似</td>
<td>包含另一模板输出</td>
</tr>
<tr>
<td>$!{evaluate("1 + 2")}</td>
<td>#evaluate("1 + 2")</td>
<td>相似</td>
<td>表达式求值</td>
</tr>
<tr>
<td>不支持</td>
<td>#stop</td>
<td>不同</td>
<td>停止模板解析</td>
</tr>
</table><h2>2.3 性能对比</h2>

<table>
<tr>
<td>引擎</td>
<td>版本</td>
<td>初始化</td>
<td>编译</td>
<td>首渲染</td>
<td>万次渲染</td>
<td>每秒次数</td>
</tr>
<tr>
<td>Freemarker</td>
<td> 2.3.18</td>
<td> 79ms</td>
<td>125ms</td>
<td> 78ms</td>
<td>16,934ms</td>
<td>590/s</td>
</tr>
<tr>
<td>Velocity</td>
<td> 1.7</td>
<td> 31ms</td>
<td>110ms</td>
<td> 31ms</td>
<td>19,278ms</td>
<td>518/s</td>
</tr>
<tr>
<td>Smarty4j</td>
<td> 1.0.0-jdk5</td>
<td> 0ms</td>
<td>78ms</td>
<td> 0ms</td>
<td>21,653ms</td>
<td>461/s</td>
</tr>
<tr>
<td>Httl</td>
<td> 0.1.0</td>
<td> 78ms</td>
<td>547ms</td>
<td> 0ms</td>
<td>2,077ms</td>
<td>4,814/s</td>
</tr>
<tr>
<td>Java</td>
<td> 1.6.0_18</td>
<td> 0ms</td>
<td>0ms</td>
<td> 0ms</td>
<td>2,016ms</td>
<td>4,960/s</td>
</tr>
</table><h1>3. 示例</h1>

<h2>3.1 调用示例</h2>

<p>BooksServlet.java:</p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">httl.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"books"</span><span class="o">,</span> <span class="n">books</span><span class="o">);</span>

<span class="n">Engine</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">Engine</span><span class="o">.</span><span class="na">getEngine</span><span class="o">();</span>
<span class="n">Template</span> <span class="n">template</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">"books.httl"</span><span class="o">);</span>
<span class="n">template</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">parameters</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">());</span>
</pre></div>

<h2>3.2 模板示例</h2>

<p>books.httl:</p>

<div class="highlight"><pre><span class="c">&lt;!--#var(User user, List&lt;Book&gt; books)--&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="c">&lt;!--#if(user.role == "admin")--&gt;</span>
    <span class="nt">&lt;table&gt;</span>
      <span class="c">&lt;!--#foreach(book in books)--&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>${book.title}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
      <span class="c">&lt;!--#end--&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
    <span class="c">&lt;!--#end--&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<h2>3.3 配置示例</h2>

<p>httl.properties:</p>

<div class="highlight"><pre><span class="na">import.packages+</span><span class="o">=</span><span class="s">com.xxx</span>
<span class="na">template.directory</span><span class="o">=</span>
<span class="na">input.encoding</span><span class="o">=</span><span class="s">UTF-8</span>
<span class="na">output.encoding</span><span class="o">=</span><span class="s">UTF-8</span>
</pre></div>

<p>其中，+=表示追加配置，而不覆盖缺省配置。
注意，所有配置项都有缺省值，如果使用缺省值，可以不配，
更多配置参见文档下面的配置参考手册。</p>

<h1>4. 下载</h1>

<h2>4.1 发布包:</h2>

<p><a href="https://github.com/httl/httl/downloads">https://github.com/httl/httl/downloads</a></p>

<h2>4.2 源代码:</h2>

<p><a href="https://github.com/httl/httl">https://github.com/httl/httl</a></p>

<p>下载源码：</p>

<div class="highlight"><pre>git clone https://github.com/httl/httl.git
</pre></div>

<p>编译源码：</p>

<div class="highlight"><pre>mvn install -Dmaven.test.skip
</pre></div>

<p>性能测试：</p>

<div class="highlight"><pre>mvn <span class="nb">test</span> -Dtest<span class="o">=</span>httl.test.PerformanceTest
</pre></div>

<p>生成Eclipse工程描述文件:</p>

<div class="highlight"><pre>mvn eclipse:eclipse -DdownloadSources
</pre></div>

<p>导入Eclipse工程：</p>

<p>Eclipse -&gt; File -&gt; Import -&gt; Existing Projects into Workspace -&gt; Browse -&gt; Finished</p>

<p>将.httl文件以html编辑器格式打开：</p>

<p>Eclipse -&gt; Window -&gt; Preferences -&gt; General -&gt; Content Types -&gt; Text -&gt; HTML -&gt; Add -&gt; .httl</p>

<h2>4.3 Maven依赖:</h2>

<div class="highlight"><pre><span class="nt">&lt;project&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>httl<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>httl<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.3.0<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>httl-repository<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>Httl Repository<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>http://httl.github.com/maven/<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>
<span class="nt">&lt;project&gt;</span>
</pre></div>

<h1>5. 模板语法</h1>

<p>基于Velocity指令和Html注释:</p>

<h2>5.1 输出指令</h2>

<h3>5.1.1 过滤输出</h3>

<p>输出表达式的计算结果，并进行过滤，比如：过滤变量中的HTML标签，防止HTML注入攻击。</p>

<div class="highlight"><pre>格式：
${expression}

示例：
${user.name}
</pre></div>

<h3>5.1.2 不过滤输出</h3>

<p>原样输出表达式的计算结果，不进行任何过滤，通常用于输出HTML片段。</p>

<div class="highlight"><pre>格式：
$!{expression}

示例：
$!{body}
</pre></div>

<h3>5.2 变量定义指令</h3>

<h3>5.2.1 类型声明</h3>

<p>声明输入变量的类型，模板内部其它变量类型基于此类型推导。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#var(type name, type name)--&gt;</span>

示例：
<span class="c">&lt;!--#var(User user, Book[] books)--&gt;</span>
</pre></div>

<h3>5.2.2 变量赋值</h3>

<p>将表达式的计算结果存入变量中。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#set(type name = expression)--&gt;</span>

示例：
<span class="c">&lt;!--#set(price = book.price * book.discount)--&gt;</span>
</pre></div>

<h2>5.3 条件指令</h2>

<h3>5.3.1 IF条件</h3>

<p>如果条件表达式计算结果为真或非空，则输出指令所包含的块。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#if(expression)--&gt;</span>

示例：
<span class="c">&lt;!--#if(user.role == "admin")--&gt;</span>
    ...
<span class="c">&lt;!--#end--&gt;</span>
</pre></div>

<h3>5.3.2 ELSEIF条件</h3>

<p>如果前面的IF条件不为真，并且当前条件表达式计算结果为真或非空，则输出指令所包含的块。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#elseif(expression)--&gt;</span>

示例：
<span class="c">&lt;!--#if(user.role == "admin")--&gt;</span>
    ...
<span class="c">&lt;!--#elseif(user.role == "member")--&gt;</span>
    ...
<span class="c">&lt;!--#end--&gt;</span>
</pre></div>

<h3>5.3.3 ELSE条件</h3>

<p>如果前面的IF条件不为真，则输出指令所包含的块。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#else--&gt;</span>

示例：
<span class="c">&lt;!--#if(user.role == "admin")--&gt;</span>
    ...
<span class="c">&lt;!--#else--&gt;</span>
    ...
<span class="c">&lt;!--#end--&gt;</span>
</pre></div>

<h2>5.4 迭代指令</h2>

<h3>5.4.1 集合迭代</h3>

<p>迭代表达式产生的集合，以集合中的每项值，重复输出指令所包含的块。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#foreach(name in expression)--&gt;</span>

示例：
<span class="c">&lt;!--#foreach(book in books)--&gt;</span>
    ...
    ${foreach.index}
    ${foreach.size}
    ${foreach.first}
    ${foreach.last}
<span class="c">&lt;!--#end--&gt;</span>
</pre></div>

<h3>5.4.3 中断迭代</h3>

<p>当条件表达式为真或非空时，中断当前迭代过程。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#breakif(expression)--&gt;</span>

示例：
<span class="c">&lt;!--#foreach(book in books)--&gt;</span>
    ...
    <span class="c">&lt;!--#breakif(foreach.index == 10)--&gt;</span>
    ...
<span class="c">&lt;!--#end--&gt;</span>
</pre></div>

<h2>5.5 宏指令</h2>

<p>将指令块封装成可复用的模板片断，在声明处不执行，在调用时再执行。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--#macro(name(type name, type name))--&gt;</span>

示例：
<span class="c">&lt;!--#macro(xxx(Book[] books))--&gt;</span>
    ...
<span class="c">&lt;!--#end--&gt;</span>
$!{xxx(books)}
</pre></div>

<h2>5.6 字面指令</h2>

<h3>5.6.1 注释块</h3>

<p>隐藏注释的内容，用于注解过程，或屏蔽指令内容。</p>

<div class="highlight"><pre>格式：
<span class="c">&lt;!--## content --&gt;</span>

示例：
<span class="c">&lt;!--## This is menu --&gt;</span>
</pre></div>

<h3>5.6.2 不解析块</h3>

<p>原样输出模板内容，用于输出纯文本内容。</p>

<div class="highlight"><pre>格式：
<span class="cp">&lt;![CDATA[## content ]]&gt;</span>

示例：
<span class="cp">&lt;![CDATA[## This is menu ]]&gt;</span>
</pre></div>

<h3>5.6.3 特殊符转义</h3>

<p>原样输出指令特殊符，用于输出纯文本内容。</p>

<div class="highlight"><pre>格式：
\#, \$, \\

示例：
<span class="c">&lt;!--\#xxx --&gt;</span>
\${xxx}
</pre></div>

<h1>6. 表达式语法</h1>

<p>基于Java表达式和扩展方法。</p>

<p>支持Java所有表达式，以下只列出与Java不同的点：</p>

<ul>
<li>所有null值的操作均返回null。</li>
<li>所有实现Comparable的对象都支持比较运算符。</li>
<li>所有对象都支持逻辑与或，分别返回空值或非空值。</li>
</ul><h2>6.1 操作符表达式</h2>

<h3>6.1.1 集合操作符</h3>

<div class="highlight"><pre><span class="nl">Sequence:</span> <span class="mi">1</span><span class="o">..</span><span class="mi">3</span>
<span class="nl">List:</span> <span class="o">[</span><span class="mi">123</span><span class="o">,</span> <span class="s">"abc"</span><span class="o">]</span>
<span class="nl">Map:</span> <span class="o">[</span><span class="s">"xxx"</span><span class="o">:</span> <span class="mi">123</span><span class="o">,</span> <span class="s">"yyy"</span><span class="o">:</span> <span class="s">"abc"</span><span class="o">]</span>
</pre></div>

<h3>6.1.2 日期操作符</h3>

<div class="highlight"><pre><span class="n">date1</span> <span class="o">&gt;</span> <span class="n">date2</span>
<span class="n">date1</span> <span class="o">&gt;=</span> <span class="n">date2</span>
<span class="n">date1</span> <span class="o">&lt;</span> <span class="n">date2</span>
<span class="n">date1</span> <span class="o">&lt;=</span> <span class="n">date2</span>
</pre></div>

<h3>6.1.3 逻辑操作符</h3>

<div class="highlight"><pre><span class="c">&lt;!--#if(object)--&gt;</span>
<span class="c">&lt;!--#if(object != null)--&gt;</span>
<span class="c">&lt;!--#if(string)--&gt;</span>
<span class="c">&lt;!--#if(string!= null &amp;&amp; string.length() &gt; 0)--&gt;</span>
<span class="c">&lt;!--#if(list)--&gt;</span>
<span class="c">&lt;!--#if(list != null &amp;&amp; list1.size() &gt; 0)--&gt;</span>

<span class="c">&lt;!--#foreach(item in list1 || list2)--&gt;</span>
<span class="c">&lt;!--#foreach(item in list1 != null &amp;&amp; list1.size() &gt; 0 ? list1 : list2)--&gt;</span>
</pre></div>

<h2>6.2 函数表达式</h2>

<h3>6.2.1 转型函数</h3>

<div class="highlight"><pre><span class="n">obj</span><span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"com.foo.Bar"</span><span class="o">)</span>
<span class="n">num</span><span class="o">.</span><span class="na">toDate</span>
<span class="n">str</span><span class="o">.</span><span class="na">toDate</span>
<span class="n">str</span><span class="o">.</span><span class="na">toDate</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">)</span>
<span class="n">str</span><span class="o">.</span><span class="na">toChar</span>
<span class="n">str</span><span class="o">.</span><span class="na">toBoolean</span>
<span class="n">str</span><span class="o">.</span><span class="na">toByte</span>
<span class="n">str</span><span class="o">.</span><span class="na">toInt</span>
<span class="n">str</span><span class="o">.</span><span class="na">toLong</span>
<span class="n">str</span><span class="o">.</span><span class="na">toFloat</span>
<span class="n">str</span><span class="o">.</span><span class="na">toDouble</span>
<span class="n">str</span><span class="o">.</span><span class="na">toClass</span>
</pre></div>

<h3>6.2.2 转义函数</h3>

<div class="highlight"><pre><span class="n">str</span><span class="o">.</span><span class="na">escapeHtml</span>
<span class="n">str</span><span class="o">.</span><span class="na">escapeUrl</span>
<span class="n">str</span><span class="o">.</span><span class="na">escapeString</span>
</pre></div>

<h3>6.2.3 格式化函数</h3>

<div class="highlight"><pre><span class="n">num</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"###,##0"</span><span class="o">)</span>
<span class="n">num</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"###,##0.##"</span><span class="o">)</span>
<span class="n">date</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"yyyy-MM-dd"</span><span class="o">)</span>
<span class="n">date</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">)</span>
</pre></div>

<h3>6.2.4 集合函数</h3>

<div class="highlight"><pre>array[index]
list[index]

map.key
map["key"]

<span class="c">&lt;!--#foreach(item in array)--&gt;</span>
${item.xxx}
<span class="c">&lt;!--#end--&gt;</span>

<span class="c">&lt;!--#foreach(item in list)--&gt;</span>
${item.xxx}
<span class="c">&lt;!--#end--&gt;</span>

<span class="c">&lt;!--#foreach(entry in map)--&gt;</span>
${entry.key}
${entry.value}
<span class="c">&lt;!--#end--&gt;</span>

sort(list)
<span class="c">&lt;!--#foreach(item in sort(list))--&gt;</span>
<span class="c">&lt;!--#end--&gt;</span>

cycle(item, item)
<span class="c">&lt;!--#set(colors = cycle("red", "blue", "green"))--&gt;</span>
${colors.next}
</pre></div>

<h3>6.2.5 文件函数</h3>

<div class="highlight"><pre><span class="n">include</span><span class="o">(</span><span class="s">"template.httl"</span><span class="o">)}</span>
<span class="n">include</span><span class="o">(</span><span class="s">"template.httl"</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">)</span>
<span class="n">include</span><span class="o">(</span><span class="n">locale</span><span class="o">(</span><span class="s">"i18n-template.httl"</span><span class="o">))</span>

<span class="n">read</span><span class="o">(</span><span class="s">"text.txt"</span><span class="o">)</span>
<span class="n">read</span><span class="o">(</span><span class="s">"text.txt"</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">)</span>
<span class="n">read</span><span class="o">(</span><span class="n">locale</span><span class="o">(</span><span class="s">"i18n-text.txt"</span><span class="o">))</span>
</pre></div>

<h3>6.2.6 系统函数</h3>

<div class="highlight"><pre><span class="n">now</span><span class="o">()</span>
<span class="n">random</span><span class="o">()</span>
<span class="n">uuid</span><span class="o">()</span>
</pre></div>

<h1>7. 详细配置</h1>

<div class="highlight"><pre><span class="c">#extensions</span>
<span class="na">engine</span><span class="o">=</span><span class="s">httl.spi.engines.DefaultEngine</span>
<span class="na">logger</span><span class="o">=</span><span class="s">httl.spi.loggers.Log4jLogger</span>
<span class="na">loggers</span><span class="o">=</span><span class="s">httl.spi.loggers.Log4jLogger</span>
<span class="na">cache</span><span class="o">=</span><span class="s">httl.spi.caches.StrongCache</span>
<span class="na">loader</span><span class="o">=</span><span class="s">httl.spi.loaders.ClasspathLoader</span>
<span class="na">parser</span><span class="o">=</span><span class="s">httl.spi.parsers.CommentParser</span>
<span class="na">translator</span><span class="o">=</span><span class="s">httl.spi.translators.DfaTranslator</span>
<span class="na">compiler</span><span class="o">=</span><span class="s">httl.spi.compilers.JdkCompiler</span>
<span class="na">formatter</span><span class="o">=</span><span class="s">httl.spi.formatters.MultiFormatter</span>
<span class="na">formatters</span><span class="o">=</span><span class="s">httl.spi.formatters.DateFormatter</span>
<span class="na">value.filter</span><span class="o">=</span><span class="s">httl.spi.filters.MultiValueFilter</span>
<span class="na">value.filters</span><span class="o">=</span><span class="s">httl.spi.filters.EscapeHtmlFilter</span>
<span class="na">text.filter</span><span class="o">=</span><span class="s">httl.spi.filters.MultiTextFilter</span>
<span class="na">text.filters</span><span class="o">=</span>
<span class="na">filters</span><span class="o">=</span>

<span class="c">#properties</span>
<span class="na">import.packages</span><span class="o">=</span><span class="s">java.util</span>
<span class="na">import.methods</span><span class="o">=</span><span class="s">httl.spi.methods.DefaultMethod</span>
<span class="na">import.macros</span><span class="o">=</span>
<span class="na">template.directory</span><span class="o">=</span>
<span class="na">template.suffix</span><span class="o">=</span><span class="s">.httl</span>
<span class="na">attribute.namespace</span><span class="o">=</span>
<span class="na">cache.capacity</span><span class="o">=</span><span class="s">0</span>
<span class="na">reloadable</span><span class="o">=</span><span class="s">false</span>
<span class="na">precompiled</span><span class="o">=</span><span class="s">false</span>
<span class="na">source.in.class</span><span class="o">=</span><span class="s">false</span>
<span class="na">text.in.class</span><span class="o">=</span><span class="s">false</span>
<span class="na">debug</span><span class="o">=</span><span class="s">false</span>
<span class="na">compile.directory</span><span class="o">=</span>
<span class="na">java.version</span><span class="o">=</span><span class="s">1.6</span>
<span class="na">foreach.status</span><span class="o">=</span><span class="s">foreach</span>
<span class="na">input.encoding</span><span class="o">=</span><span class="s">UTF-8</span>
<span class="na">output.encoding</span><span class="o">=</span><span class="s">UTF-8</span>
<span class="na">output.stream</span><span class="o">=</span><span class="s">false</span>
<span class="na">locale</span><span class="o">=</span><span class="s">en_US</span>
<span class="na">time.zone</span><span class="o">=</span><span class="s">+0</span>
<span class="na">date.format</span><span class="o">=</span><span class="s">yyyy-MM-dd HH:mm:ss</span>
<span class="na">number.format</span><span class="o">=</span><span class="s">###,##0.###</span>
<span class="na">null.value</span><span class="o">=</span>
<span class="na">true.value</span><span class="o">=</span><span class="s">true</span>
<span class="na">false.value</span><span class="o">=</span><span class="s">false</span>
<span class="na">sequences</span><span class="o">=</span><span class="s">Mon Tue Wed Thu Fri Sat Sun Mon,\</span>
<span class="s">Monday Tuesday Wednesday Thursday Friday Saturday Sunday Monday,\</span>
<span class="s">Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec Jan,\</span>
<span class="s">January February March May June July August September October November December January</span>
</pre></div>

<h1>7. 设计</h1>

<h2>7.1 类关系</h2>

<p><img src="http://httl.googlecode.com/svn/trunk/httl-doc/httl-class-diagram.jpg" alt="ClassDiagram"></p>

<p>分包原则：按复用的粒度分包，如果某些类总是一起被复用，则放在一个包下面。 </p>

<p>HTTL有两种用户： </p>

<ol>
<li><p>一种是模板引擎的使用者， </p></li>
<li><p>一种是模板引擎的扩展者。 </p></li>
</ol><p>每种用户所需用到的类，就是同一复用粒度的。 </p>

<p>所以在整体上划分为三层： </p>

<ol>
<li><p>API (Application Programming Interface) 直接使用者需要导入的接口。</p></li>
<li><p>SPI (Service Provider Interface)  扩展者需要导入的接口。 </p></li>
<li><p>Impl (Built-in Implementation) 内置扩展实现。 </p></li>
</ol><p>使用者API导入： </p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">httl.*</span><span class="o">;</span>  
</pre></div>

<p>扩展者SPI导入： </p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">httl.spi.*</span><span class="o">;</span>
</pre></div>

<h2>7.2 调用过程</h2>

<p><img src="http://httl.googlecode.com/svn/trunk/httl-doc/httl-sequence-diagram.jpg" alt="Sequence diagram"></p>

<p>执行过程说明：(与上图中的序号对应) </p>

<ol>
<li><p>当从引擎中获取模板时， </p></li>
<li><p>首先会在缓存查找是否已缓存，如果有缓存就直接返回， </p></li>
<li><p>如果没有，则加载模板， </p></li>
<li><p>接着进行模板语法解析， </p></li>
<li><p>在解析到表达式时，将其转译为Java表达式， </p></li>
<li><p>并对静态文本进行编译前过滤，比如删除空白等， </p></li>
<li><p>对解析后的Java代码进行编译，得到Template的具体模板实现类， </p></li>
<li><p>实例化模板实现类， </p></li>
<li><p>将模板实例写入缓存，并返回给用户， </p></li>
<li><p>当用户调用模板的渲染方法时， </p></li>
<li><p>将静态模板文本直接输出， </p></li>
<li><p>将动态占位符内容，先格式化成字符串， </p></li>
<li><p>再进行过滤，比如转义动态内容的HTML特殊符，</p></li>
<li><p>然后输出过滤后的内容。 </p></li>
</ol>
      </section>
    </div>

    
  </body>
</html>
